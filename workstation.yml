---
- name: Configure my Fedora workstation
  hosts: workstation
  become: yes
  tasks:

  - name: Ensure required software packages to run this playbook are installed
    dnf:
      name:
        - pass
        - restic

  - name: Specify hostname
    hostname:
      name: lenovo

  - name: Restore backup
    become: false
    command: >-
      bash -c "
        if test ! -d ${HOME}/$(pass restic | sed -n 4p); then
          restic --password-file <(pass restic | sed -n 1p) -r $(pass restic | sed -n 2p) restore latest --target $HOME
          echo 'Restore backup'
        fi"
    register: restore_backup
    changed_when: "'Restore backup' in restore_backup.stdout"

  - name: Ensure the latest version of various software packages are installed
    dnf:
      name:
        - cppcheck
        - devscripts-checkbashisms
        - emacs
        - gdal-devel
        - gdb
        - geos-devel
        - gsl-devel
        - mesa-libGLU-devel
        - libcurl-devel
        - libjpeg-turbo-devel
        - libxml2-devel
        - pandoc
        - pandoc-citeproc
        - poppler-cpp-devel
        - proj-devel
        - R
        - sqlite-devel
        - texlive-adjustbox
        - texlive-algorithmicx
        - texlive-authoraftertitle
        - texlive-datetime
        - texlive-draftwatermark
        - texlive-doublestroke
        - texlive-floatrow
        - texlive-framed
        - texlive-lastpage
        - texlive-lato
        - texlive-lettrine
        - texlive-mdframed
        - texlive-multirow
        - texlive-numprint
        - texlive-preprint
        - texlive-sidecap
        - texlive-sttools
        - texlive-tcolorbox
        - texlive-titling
        - texlive-threeparttable
        - texlive-totcount
        - texlive-was
        - texlive-xpatch
        - udunits2-devel
      state: latest

  - name: Turn off the Gnome beep sound
    become: false
    dconf:
      key: "/org/gnome/desktop/sound/event-sounds"
      value: "false"
      state: present

  - name: Set wallpaper
    become: false
    dconf:
      key: "/org/gnome/desktop/background/picture-uri"
      value: "'{{ lookup('env', 'PWD') }}/wallpaper.jpg'"
      state: present

  - name: Ensure the 'alias backup' is set
    become: false
    lineinfile:
      path: $HOME/.bashrc
      regexp: '^alias backup='
      line: alias backup="restic --password-file <(pass restic | sed -n 1p) -r \$(pass restic | sed -n 2p) backup \$(pass restic | sed -n 3p)"

  - name: Ensure the 'alias snapshots' is set
    become: false
    lineinfile:
      path: $HOME/.bashrc
      regexp: '^alias snapshots='
      line: alias snapshots="restic --password-file <(pass restic | sed -n 1p) -r \$(pass restic | sed -n 2p) snapshots"

  - name: Create a directory for R packages if it does not exist
    become: false
    file:
      path: $HOME/R/library
      state: directory
      mode: '0755'

  - name: Create a directory for a '~/.R/Makevars' file if it does not exist
    become: false
    file:
      path: $HOME/.R
      state: directory
      mode: '0755'

  - name: >
      Create a '~/.R/Makevars' file with some out-commented
      examples of how to modify package compilation.
    become: false
    copy:
      dest: $HOME/.R/Makevars
      force: no
      content: |
        # CFLAGS = -Wall -pedantic
        # CFLAGS = -Wall -Wextra -pedantic -Wno-cast-function-type
        # CFLAGS = -Wall -Wextra -pedantic
        # CFLAGS = -Wall -flto -pedantic
        # CFLAGS = -Wall -Wextra -pedantic -ggdb -O0
        # CFLAGS = -ggdb -O0
        # CFLAGS=-g -O3 -Wall -pedantic -std=gnu99 -mtune=native -pipe
        # CFLAGS=
        # CC=clang
        # CC=ccache gcc
        # VER=
        # CCACHE=ccache
        # CC=$(CCACHE) gcc$(VER)
        # CXX=$(CCACHE) g++$(VER)
        # CXX11=$(CCACHE) g++$(VER)
        # CXX14=$(CCACHE) g++$(VER)
        # FC=$(CCACHE) gfortran$(VER)
        # F77=$(CCACHE) gfortran$(VER)

  - name: Create a '~/.Renviron' file
    become: false
    copy:
      dest: $HOME/.Renviron
      force: no
      content: |
        R_LIBS_USER=~/R/library

  - name: Create a '~/.Rprofile' file
    become: false
    copy:
      dest: $HOME/.Rprofile
      force: no
      content: |
        options(repos = c(CRAN="https://cran.r-project.org"))

  - name: Create a '~/.gdbinit' file
    become: false
    copy:
      dest: $HOME/.gdbinit
      force: no
      content: |
        set style enabled off
        set history save on

  - name: Ensure that the 'emacs' configuration exists
    become: false
    git:
      repo: 'https://github.com/stewid/.emacs.d.git'
      dest: $HOME/.emacs.d
      update: no

  - name: Ensure the EDITOR environment variable is set
    become: false
    lineinfile:
      path: $HOME/.bashrc
      regexp: '^export EDITOR='
      line: export EDITOR=emacs

  - name: Install some R packages
    become: false
    command: >-
        Rscript --no-restore --no-save -e "
          if (!('{{ item }}' %in% installed.packages()[,'Package'])) {
              tryCatch(install.packages('{{ item }}'),
                       warning = function(w) stop(w))
              cat('Install package')
          }"
    register: r_install
    changed_when: "'Install package' in r_install.stdout"
    with_items:
      - bookdown
      - getPass
      - knitr
      - raster
      - rgl
      - rmarkdown
      - roxygen2
      - pdftools
      - SimInf
      - sf
      - sp
      - xml2

  - name: Set user name for git
    become: false
    git_config:
      name: user.name
      scope: global
      value: Stefan Widgren

  - name: Set user email for git
    become: false
    git_config:
      name: user.email
      scope: global
      value: stefan.widgren@gmail.com

  - name: Set core editor for git
    become: false
    git_config:
      name: core.editor
      scope: global
      value: emacs

  - name: Set ui color for git
    become: false
    git_config:
      name: color.ui
      scope: global
      value: 'false'

  - name: Add file enumeration of untracked files in git
    become: false
    git_config:
      name: status.showUntrackedFiles
      scope: global
      value: all
